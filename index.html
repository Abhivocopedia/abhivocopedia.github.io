<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MuseVision - Museum Scanner</title>
    <style>
        /* === CSS VARIABLES === */
        :root {
            --dark: #0a0a0a;
            --dark-gray: #1a1a1a;
            --medium-gray: #333333;
            --light-gray: #666666;
            --lighter-gray: #999999;
            --light: #ffffff;
            --accent: #ffffff;
            --primary-bg: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --secondary-bg: rgba(30, 30, 40, 0.95);
            --card-bg: rgba(39, 39, 55, 0.98);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --accent-color: #a78bfa;
            --accent-hover: #8b5cf6;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --scan-overlay: rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            --dark: #f8fafc;
            --dark-gray: #e2e8f0;
            --medium-gray: #cbd5e1;
            --light-gray: #94a3b8;
            --lighter-gray: #64748b;
            --light: #0f172a;
            --accent: #0f172a;
            --primary-bg: linear-gradient(135deg, #f1f5f9 0%, #e0e7ff 100%);
            --secondary-bg: rgba(255, 255, 255, 0.95);
            --card-bg: rgba(255, 255, 255, 0.98);
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --accent-color: #8b5cf6;
            --accent-hover: #7c3aed;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --scan-overlay: rgba(255, 255, 255, 0.3);
        }

        /* === BASE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* === BACKGROUND EFFECTS === */
        .background-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .shape {
            position: absolute;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: float 20s infinite linear;
        }

        [data-theme="light"] .shape {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .shape:nth-child(1) {
            width: 80px;
            height: 80px;
            top: 10%;
            left: 10%;
            animation-delay: 0s;
            animation-duration: 25s;
        }

        .shape:nth-child(2) {
            width: 120px;
            height: 120px;
            top: 60%;
            left: 80%;
            animation-delay: -5s;
            animation-duration: 30s;
        }

        .shape:nth-child(3) {
            width: 60px;
            height: 60px;
            top: 80%;
            left: 20%;
            animation-delay: -10s;
            animation-duration: 20s;
        }

        .shape:nth-child(4) {
            width: 100px;
            height: 100px;
            top: 20%;
            left: 70%;
            animation-delay: -15s;
            animation-duration: 35s;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(100px, 50px) rotate(90deg);
            }
            50% {
                transform: translate(50px, 100px) rotate(180deg);
            }
            75% {
                transform: translate(-50px, 50px) rotate(270deg);
            }
        }

        .grid-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
        }

        [data-theme="light"] .grid-pattern {
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
        }

        @keyframes gridMove {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(50px, 50px);
            }
        }

        /* === APP LAYOUT === */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: var(--secondary-bg);
            backdrop-filter: blur(20px);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }

        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-color), #EC4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* === ADMIN ACCESS === */
        .admin-access {
            position: relative;
        }

        .admin-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        .admin-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--card-bg);
            border-left: 1px solid var(--border-color);
            padding: 2rem;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 2001;
        }

        .admin-panel.open {
            right: 0;
        }

        .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
        }

        .admin-overlay.show {
            display: block;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .admin-section {
            margin-bottom: 2rem;
        }

        .admin-section h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .admin-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .admin-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--secondary-bg);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .admin-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .admin-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .admin-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .admin-btn-primary {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            flex: 1;
        }

        .admin-btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            flex: 1;
        }

        /* === IMAGE UPLOAD STYLES === */
        .image-upload-container {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--secondary-bg);
        }

        .image-upload-container:hover {
            border-color: var(--accent-color);
            background: rgba(139, 92, 246, 0.05);
        }

        .image-upload-container.dragover {
            border-color: var(--accent-color);
            background: rgba(139, 92, 246, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .upload-hint {
            font-size: 0.8rem;
            color: var(--light-gray);
        }

        .image-preview {
            margin-top: 1rem;
            display: none;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .remove-image {
            background: #EF4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .file-input {
            display: none;
        }

        .uploaded-artworks {
            max-height: 300px;
            overflow-y: auto;
        }

        .artwork-item {
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .artwork-item h4 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .artwork-item p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .artwork-image {
            max-width: 100%;
            max-height: 100px;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }

        /* === MODE TOGGLE === */
        .mode-toggle {
            display: flex;
            background: var(--card-bg);
            border-radius: 25px;
            padding: 4px;
            border: 1px solid var(--border-color);
        }

        .mode-option {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-option.active {
            background: var(--accent-color);
            color: white;
        }

        /* === THEME TOGGLE === */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--card-bg);
            border-radius: 25px;
            border: 2px solid var(--accent-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 0 5px;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            transition: transform 0.3s ease;
        }

        [data-theme="light"] .theme-toggle::before {
            transform: translateX(0);
        }

        [data-theme="dark"] .theme-toggle::before {
            transform: translateX(30px);
        }

        .theme-toggle-icons {
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        /* === MAIN CONTENT === */
        .app-main {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* === COMFORT FILTERS === */
        .comfort-filters {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 20px;
            margin: 1rem 0;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .filter-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--secondary-bg);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .filter-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .interest-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .interest-tag {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background: var(--secondary-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .interest-tag.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* === SCANNER === */
        .scanner-container {
            width: 100%;
            max-width: 400px;
            margin: 1rem 0;
        }

        .scanner-view {
            width: 100%;
            height: 300px;
            background: var(--card-bg);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--accent-color);
            position: relative;
            overflow: hidden;
        }

        #cameraPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--scan-overlay);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scan-frame {
            width: 200px;
            height: 200px;
            border: 3px solid var(--accent-color);
            border-radius: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
            }
            50% { 
                opacity: 0.7;
            }
        }

        .scan-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .scan-button:hover {
            background: var(--accent-hover);
        }

        .scan-button.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* === ARTWORK INFO === */
        .artwork-info {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 20px;
            margin: 1rem 0;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .artwork-header {
            margin-bottom: 1rem;
        }

        .artwork-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .artwork-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .meta-tag {
            background: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .artwork-description {
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        .artwork-image-display {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 2px solid var(--border-color);
        }

        .artwork-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .read-aloud-btn {
            background: var(--accent-color);
            color: white;
        }

        .save-btn {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* === FOOTER === */
        .app-footer {
            background: var(--secondary-bg);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border-color);
        }

        .footer-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .map-btn {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .exit-btn {
            background: var(--accent-color);
            color: white;
        }

        .footer-btn:hover {
            transform: translateY(-2px);
        }

        /* === UTILITY CLASSES === */
        .hidden {
            display: none !important;
        }

        /* === MODAL === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
        }

        /* === TOAST === */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-gray);
            color: var(--light);
            padding: 15px 25px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            z-index: 10001;
            max-width: 300px;
            text-align: center;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .app-header {
                padding: 0.75rem;
            }

            .app-header h1 {
                font-size: 1.3rem;
            }

            .comfort-filters {
                padding: 1rem;
            }

            .artwork-info {
                padding: 1rem;
            }

            .scanner-view {
                height: 250px;
            }

            .scan-frame {
                width: 180px;
                height: 180px;
            }
            
            .footer-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .admin-panel {
                width: 100%;
                right: -100%;
            }
        }
        
        @media (max-width: 480px) {
            .app-main {
                padding: 0.5rem;
            }
            
            .header-controls {
                gap: 0.5rem;
            }
            
            .mode-toggle {
                padding: 2px;
            }
            
            .mode-option {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .theme-toggle {
                width: 50px;
                height: 25px;
            }
            
            .theme-toggle::before {
                width: 17px;
                height: 17px;
            }
            
            [data-theme="dark"] .theme-toggle::before {
                transform: translateX(25px);
            }

            .admin-btn span {
                display: none;
            }

            .image-upload-container {
                padding: 1rem;
            }

            .upload-icon {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="background-effects">
        <div class="floating-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
        <div class="grid-pattern"></div>
    </div>

    <!-- Admin Panel Overlay -->
    <div class="admin-overlay" id="adminOverlay"></div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h2 class="admin-title">üèõÔ∏è Admin Panel</h2>
            <button class="close-btn" onclick="app.closeAdminPanel()">√ó</button>
        </div>
        
        <div class="admin-section">
            <h3>üìÅ Upload Artwork</h3>
            <div class="admin-form">
                <!-- Image Upload Area -->
                <div class="image-upload-container" id="imageUploadContainer" onclick="document.getElementById('imageFileInput').click()">
                    <div class="upload-icon">üñºÔ∏è</div>
                    <div class="upload-text">Click to upload artwork image</div>
                    <div class="upload-hint">or drag and drop here</div>
                    <input type="file" id="imageFileInput" class="file-input" accept="image/*" onchange="app.handleImageUpload(event)">
                </div>
                
                <!-- Image Preview -->
                <div class="image-preview" id="imagePreview">
                    <img id="previewImage" src="" alt="Artwork preview">
                    <button class="remove-image" onclick="app.removeUploadedImage()">Remove Image</button>
                </div>

                <input type="text" class="admin-input" id="adminArtworkName" placeholder="Artwork Name">
                <input type="text" class="admin-input" id="adminArtist" placeholder="Artist">
                <input type="text" class="admin-input" id="adminEra" placeholder="Era/Period">
                <input type="text" class="admin-input" id="adminYear" placeholder="Year">
                <input type="text" class="admin-input" id="adminType" placeholder="Type (Painting, Sculpture, etc.)">
                <textarea class="admin-input admin-textarea" id="adminDescription" placeholder="Description"></textarea>
                <textarea class="admin-input admin-textarea" id="adminSignificance" placeholder="Historical Significance"></textarea>
                <input type="text" class="admin-input" id="adminLocation" placeholder="Current Location">
                
                <div class="admin-actions">
                    <button class="admin-btn-primary" onclick="app.uploadArtwork()">
                        üíæ Save Artwork
                    </button>
                    <button class="admin-btn-secondary" onclick="app.clearAdminForm()">
                        üóëÔ∏è Clear
                    </button>
                </div>
            </div>
        </div>

        <div class="admin-section">
            <h3>üìä Database Management</h3>
            <div class="admin-actions">
                <button class="admin-btn-primary" onclick="app.exportDatabase()">
                    üì• Export DB
                </button>
                <button class="admin-btn-secondary" onclick="app.clearDatabase()">
                    üóëÔ∏è Clear DB
                </button>
            </div>
        </div>

        <div class="admin-section">
            <h3>üñºÔ∏è Uploaded Artworks</h3>
            <div class="uploaded-artworks" id="uploadedArtworksList">
                <!-- Artworks will be populated here -->
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app">
        <header class="app-header">
            <h1>MuseVision</h1>
            <div class="header-controls">
                <!-- Hidden Admin Access -->
                <div class="admin-access">
                    <button class="admin-btn" id="adminAccessBtn" title="Admin Access">
                        ‚öôÔ∏è <span>Admin</span>
                    </button>
                </div>
                
                <div class="mode-toggle">
                    <button class="mode-option active" data-mode="normal">Normal</button>
                    <button class="mode-option" data-mode="comfort">Comfort</button>
                </div>
                <div class="theme-toggle" id="themeToggle">
                    <div class="theme-toggle-icons">üåô ‚òÄÔ∏è</div>
                </div>
            </div>
        </header>

        <main class="app-main">
            <!-- Comfort Mode Filters -->
            <div class="comfort-filters hidden" id="comfortFilters">
                <div class="filter-group">
                    <label for="ageFilter">Your Age:</label>
                    <input type="number" id="ageFilter" min="5" max="100" placeholder="Enter your age">
                </div>
                <div class="filter-group">
                    <label>Your Interests:</label>
                    <div class="interest-tags" id="interestTags">
                        <!-- Interests will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Live Camera Scanner -->
            <div class="scanner-container">
                <div class="scanner-view">
                    <video id="cameraPreview" autoplay playsinline></video>
                    <div class="scanner-overlay">
                        <div class="scan-frame"></div>
                    </div>
                </div>
                <button class="scan-button" id="scanButton">
                    <span>üì∑ Capture & Scan</span>
                </button>
                <canvas id="captureCanvas" class="hidden"></canvas>
            </div>

            <!-- Artwork Info Display -->
            <div class="artwork-info hidden" id="artworkInfo">
                <!-- Dynamic content from Gemini AI -->
            </div>

            <!-- Camera Permission Modal -->
            <div class="modal hidden" id="cameraModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">üì∑ Camera Access Required</h2>
                    </div>
                    <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                        MuseVision needs camera access to scan artworks. Please allow camera permissions to continue.
                    </p>
                    <button class="scan-button" onclick="app.initCamera()" style="margin-top: 0;">
                        Allow Camera Access
                    </button>
                </div>
            </div>
        </main>

        <footer class="app-footer">
            <button class="footer-btn map-btn" id="mapButton">
                üó∫Ô∏è Museum Map
            </button>
            <button class="footer-btn exit-btn" id="exitButton">
                üö™ Exit Tour
            </button>
        </footer>
    </div>

    <!-- Exit Summary Modal -->
    <div class="modal hidden" id="summaryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä Your Visit Summary</h2>
                <button class="close-btn" onclick="app.closeSummaryModal()">√ó</button>
            </div>
            <div id="summaryContent">
                <!-- Summary content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast hidden" id="toast"></div>

    <script>
        // API Keys Configuration
        const CONFIG = {
            GEMINI_API_KEY: "AIzaSyANyvyftAGbiBYCF5Z2V9W7EWTSSB2Nr5o",
            MURF_API_KEY: "ap2_d5348bf2-ae97-414a-a2b0-4c4d3faef92c",
            INTERESTS: [
                'Renaissance', 'Modern Art', 'Sculpture', 'Ancient History', 
                'Asian Art', 'European Masters', 'Contemporary', 'Religious Art',
                'Impressionism', 'Abstract', 'Portraits', 'Landscapes'
            ],
            // Admin credentials (in production, this should be server-side)
            ADMIN_CREDENTIALS: {
                username: "museum_admin",
                password: "MuseVision2024!"
            }
        };

        // Main App Class
        class MuseVersionApp {
            constructor() {
                this.state = {
                    currentMode: 'normal',
                    theme: 'dark',
                    filters: { age: null, interests: [] },
                    scannedHistory: [],
                    currentArtwork: null,
                    visitorId: this.generateUUID(),
                    cameraStream: null,
                    isAdmin: false,
                    adminArtworks: [], // Database for admin-uploaded artworks
                    currentUploadedImage: null
                };
            }

            // Initialize App
            init() {
                this.loadSavedState();
                this.setupEventListeners();
                this.renderInterests();
                this.updateTheme();
                this.initCamera();
                this.loadAdminArtworks();
                this.setupDragAndDrop();
                
                console.log('MuseVision App Initialized');
            }

            // Generate UUID
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // Load saved state
            loadSavedState() {
                const savedId = localStorage.getItem('museversion_visitor_id');
                const savedTheme = localStorage.getItem('museversion_theme');
                const savedHistory = localStorage.getItem('museversion_history');
                const savedFilters = localStorage.getItem('museversion_filters');

                if (savedId) this.state.visitorId = savedId;
                else localStorage.setItem('museversion_visitor_id', this.state.visitorId);

                if (savedTheme) this.state.theme = savedTheme;
                if (savedHistory) this.state.scannedHistory = JSON.parse(savedHistory);
                if (savedFilters) this.state.filters = JSON.parse(savedFilters);
            }

            // Load admin artworks from localStorage
            loadAdminArtworks() {
                const savedArtworks = localStorage.getItem('museversion_admin_artworks');
                if (savedArtworks) {
                    this.state.adminArtworks = JSON.parse(savedArtworks);
                }
                this.renderAdminArtworks();
            }

            // Save admin artworks to localStorage
            saveAdminArtworks() {
                localStorage.setItem('museversion_admin_artworks', JSON.stringify(this.state.adminArtworks));
                this.renderAdminArtworks();
            }

            // Setup drag and drop for image upload
            setupDragAndDrop() {
                const uploadContainer = document.getElementById('imageUploadContainer');
                
                uploadContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadContainer.classList.add('dragover');
                });

                uploadContainer.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadContainer.classList.remove('dragover');
                });

                uploadContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadContainer.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleImageUpload({ target: { files: files } });
                    }
                });
            }

            // Handle image upload
            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Check if file is an image
                if (!file.type.startsWith('image/')) {
                    this.showToast('Please upload an image file', 'error');
                    return;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    this.showToast('Image size should be less than 5MB', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.state.currentUploadedImage = e.target.result;
                    this.showImagePreview(this.state.currentUploadedImage);
                    this.showToast('Image uploaded successfully!', 'success');
                };
                reader.readAsDataURL(file);
            }

            // Show image preview
            showImagePreview(imageData) {
                const previewContainer = document.getElementById('imagePreview');
                const previewImage = document.getElementById('previewImage');
                
                previewImage.src = imageData;
                previewContainer.style.display = 'block';
            }

            // Remove uploaded image
            removeUploadedImage() {
                this.state.currentUploadedImage = null;
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('imageFileInput').value = '';
                this.showToast('Image removed', 'info');
            }

            // Render admin artworks list
            renderAdminArtworks() {
                const container = document.getElementById('uploadedArtworksList');
                if (this.state.adminArtworks.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No artworks uploaded yet.</p>';
                    return;
                }

                container.innerHTML = this.state.adminArtworks.map(artwork => `
                    <div class="artwork-item">
                        ${artwork.imageData ? `<img src="${artwork.imageData}" class="artwork-image" alt="${artwork.name}">` : ''}
                        <h4>${artwork.name}</h4>
                        <p><strong>Artist:</strong> ${artwork.artist}</p>
                        <p><strong>Type:</strong> ${artwork.type}</p>
                        <p><strong>Uploaded:</strong> ${new Date(artwork.uploadedAt).toLocaleDateString()}</p>
                        <button class="admin-btn-secondary" onclick="app.deleteArtwork('${artwork.id}')" style="margin-top: 0.5rem; padding: 6px 12px; font-size: 0.8rem;">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `).join('');
            }

            // Setup event listeners
            setupEventListeners() {
                // Mode toggle
                document.querySelectorAll('.mode-option').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.setMode(e.target.dataset.mode);
                    });
                });

                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });

                // Admin access
                document.getElementById('adminAccessBtn').addEventListener('click', () => {
                    this.requestAdminAccess();
                });

                // Age filter
                document.getElementById('ageFilter').addEventListener('input', (e) => {
                    const age = parseInt(e.target.value);
                    if (age >= 5 && age <= 100) {
                        this.state.filters.age = age;
                        this.saveFilters();
                    } else if (e.target.value === '') {
                        this.state.filters.age = null;
                        this.saveFilters();
                    }
                });

                // Scan button
                document.getElementById('scanButton').addEventListener('click', () => {
                    this.captureAndScan();
                });

                // Exit button
                document.getElementById('exitButton').addEventListener('click', () => {
                    this.showExitSummary();
                });

                // Map button
                document.getElementById('mapButton').addEventListener('click', () => {
                    this.showMuseumMap();
                });

                // Close modal when clicking outside
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.classList.add('hidden');
                    }
                });

                // Close admin panel when clicking overlay
                document.getElementById('adminOverlay').addEventListener('click', () => {
                    this.closeAdminPanel();
                });
            }

            // Request admin access
            requestAdminAccess() {
                if (this.state.isAdmin) {
                    this.openAdminPanel();
                    return;
                }

                const username = prompt('Enter admin username:');
                if (!username) return;

                const password = prompt('Enter admin password:');
                if (!password) return;

                if (username === CONFIG.ADMIN_CREDENTIALS.username && 
                    password === CONFIG.ADMIN_CREDENTIALS.password) {
                    this.state.isAdmin = true;
                    this.openAdminPanel();
                    this.showToast('Admin access granted!', 'success');
                } else {
                    this.showToast('Invalid credentials', 'error');
                }
            }

            // Open admin panel
            openAdminPanel() {
                if (!this.state.isAdmin) {
                    this.showToast('Admin access required', 'error');
                    return;
                }

                document.getElementById('adminPanel').classList.add('open');
                document.getElementById('adminOverlay').classList.add('show');
            }

            // Close admin panel
            closeAdminPanel() {
                document.getElementById('adminPanel').classList.remove('open');
                document.getElementById('adminOverlay').classList.remove('show');
            }

            // Upload artwork to database
            uploadArtwork() {
                const name = document.getElementById('adminArtworkName').value.trim();
                const artist = document.getElementById('adminArtist').value.trim();
                const era = document.getElementById('adminEra').value.trim();
                const year = document.getElementById('adminYear').value.trim();
                const type = document.getElementById('adminType').value.trim();
                const description = document.getElementById('adminDescription').value.trim();
                const significance = document.getElementById('adminSignificance').value.trim();
                const location = document.getElementById('adminLocation').value.trim();

                if (!name || !artist || !description) {
                    this.showToast('Please fill in required fields: Name, Artist, and Description', 'error');
                    return;
                }

                const artwork = {
                    id: this.generateUUID(),
                    name,
                    artist,
                    era: era || 'Unknown Period',
                    year: year || 'Unknown',
                    type: type || 'Artwork',
                    description,
                    significance: significance || 'Cultural and historical significance',
                    location: location || 'Unknown Location',
                    imageData: this.state.currentUploadedImage,
                    uploadedAt: new Date().toISOString(),
                    source: 'admin',
                    confidence: 'verified'
                };

                this.state.adminArtworks.push(artwork);
                this.saveAdminArtworks();
                this.clearAdminForm();
                this.showToast('Artwork uploaded to database!', 'success');
            }

            // Clear admin form
            clearAdminForm() {
                document.getElementById('adminArtworkName').value = '';
                document.getElementById('adminArtist').value = '';
                document.getElementById('adminEra').value = '';
                document.getElementById('adminYear').value = '';
                document.getElementById('adminType').value = '';
                document.getElementById('adminDescription').value = '';
                document.getElementById('adminSignificance').value = '';
                document.getElementById('adminLocation').value = '';
                this.removeUploadedImage();
            }

            // Delete artwork from database
            deleteArtwork(artworkId) {
                if (confirm('Are you sure you want to delete this artwork?')) {
                    this.state.adminArtworks = this.state.adminArtworks.filter(art => art.id !== artworkId);
                    this.saveAdminArtworks();
                    this.showToast('Artwork deleted from database', 'success');
                }
            }

            // Export database
            exportDatabase() {
                const data = {
                    adminArtworks: this.state.adminArtworks,
                    exportDate: new Date().toISOString(),
                    totalArtworks: this.state.adminArtworks.length
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `musevision-database-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showToast('Database exported!', 'success');
            }

            // Clear database
            clearDatabase() {
                if (confirm('Are you sure you want to clear the entire database? This action cannot be undone.')) {
                    this.state.adminArtworks = [];
                    this.saveAdminArtworks();
                    this.showToast('Database cleared!', 'success');
                }
            }

            // Render interests
            renderInterests() {
                const container = document.getElementById('interestTags');
                container.innerHTML = CONFIG.INTERESTS.map(interest => `
                    <div class="interest-tag ${this.state.filters.interests.includes(interest) ? 'active' : ''}" data-interest="${interest}">${interest}</div>
                `).join('');

                // Add click listeners
                container.addEventListener('click', (e) => {
                    if (e.target.classList.contains('interest-tag')) {
                        this.toggleInterest(e.target.dataset.interest, e.target);
                    }
                });
            }

            // Toggle interest
            toggleInterest(interest, element) {
                const index = this.state.filters.interests.indexOf(interest);
                if (index > -1) {
                    this.state.filters.interests.splice(index, 1);
                    element.classList.remove('active');
                } else {
                    this.state.filters.interests.push(interest);
                    element.classList.add('active');
                }
                this.saveFilters();
            }

            saveFilters() {
                localStorage.setItem('museversion_filters', JSON.stringify(this.state.filters));
            }

            // Set mode
            setMode(mode) {
                this.state.currentMode = mode;
                
                // Update UI
                document.querySelectorAll('.mode-option').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });

                // Show/hide comfort filters
                document.getElementById('comfortFilters').classList.toggle('hidden', mode !== 'comfort');
            }

            // Theme management
            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                this.updateTheme();
            }

            updateTheme() {
                document.documentElement.setAttribute('data-theme', this.state.theme);
                localStorage.setItem('museversion_theme', this.state.theme);
            }

            // Camera functions - FIXED FOR PHONE COMPATIBILITY
            initCamera() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.showToast('Camera not supported on this device', 'error');
                    document.getElementById('cameraModal').classList.remove('hidden');
                    return;
                }

                // Request camera with phone-friendly settings
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Use rear camera
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                })
                .then((stream) => {
                    this.state.cameraStream = stream;
                    const video = document.getElementById('cameraPreview');
                    video.srcObject = stream;
                    
                    // Handle video loading for mobile devices
                    video.onloadedmetadata = () => {
                        video.play().catch(e => {
                            console.error('Error playing video:', e);
                        });
                    };
                    
                    document.getElementById('cameraModal').classList.add('hidden');
                    this.showToast('Camera activated successfully!', 'success');
                })
                .catch((error) => {
                    console.error('Camera error:', error);
                    document.getElementById('cameraModal').classList.remove('hidden');
                    
                    // Provide specific error messages
                    if (error.name === 'NotAllowedError') {
                        this.showToast('Camera permission denied. Please allow camera access in your browser settings.', 'error');
                    } else if (error.name === 'NotFoundError') {
                        this.showToast('No camera found on this device.', 'error');
                    } else if (error.name === 'NotSupportedError') {
                        this.showToast('Camera not supported in this browser.', 'error');
                    } else {
                        this.showToast('Failed to access camera: ' + error.message, 'error');
                    }
                });
            }

            // Capture and scan artwork
            async captureAndScan() {
                // Use demo mode if API key is not properly configured
                if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY.includes("YOUR_API_KEY")) {
                    this.showToast('Using demo mode - configure API key for real scanning', 'info');
                    this.demoScan();
                    return;
                }

                if (!this.state.cameraStream) {
                    this.showToast('Please allow camera access first', 'error');
                    document.getElementById('cameraModal').classList.remove('hidden');
                    return;
                }

                try {
                    const scanButton = document.getElementById('scanButton');
                    scanButton.classList.add('loading');
                    scanButton.innerHTML = '<span>üîç Scanning...</span>';

                    // Capture frame
                    const canvas = document.getElementById('captureCanvas');
                    const context = canvas.getContext('2d');
                    const video = document.getElementById('cameraPreview');
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Identify artwork using Gemini AI
                    const artwork = await this.identifyArtworkWithGemini(imageData);
                    
                    this.state.currentArtwork = artwork;
                    this.state.scannedHistory.push({
                        ...artwork,
                        timestamp: new Date().toISOString(),
                        scanId: this.generateUUID()
                    });

                    this.displayArtworkInfo(artwork);
                    this.logScanActivity(artwork);
                    this.showToast(`Identified: ${artwork.name}`, 'success');

                } catch (error) {
                    console.error('Error scanning artwork:', error);
                    this.showToast(error.message, 'error');
                } finally {
                    const scanButton = document.getElementById('scanButton');
                    scanButton.classList.remove('loading');
                    scanButton.innerHTML = '<span>üì∑ Capture & Scan</span>';
                }
            }

            // Demo mode for testing without API
            async demoScan() {
                const scanButton = document.getElementById('scanButton');
                scanButton.classList.add('loading');
                scanButton.innerHTML = '<span>üîç Scanning...</span>';

                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Check if we have admin-uploaded artworks first
                if (this.state.adminArtworks.length > 0) {
                    const randomArtwork = this.state.adminArtworks[Math.floor(Math.random() * this.state.adminArtworks.length)];
                    this.state.currentArtwork = randomArtwork;
                    this.state.scannedHistory.push({
                        ...randomArtwork,
                        timestamp: new Date().toISOString(),
                        scanId: this.generateUUID()
                    });

                    this.displayArtworkInfo(randomArtwork);
                    this.logScanActivity(randomArtwork);
                    this.showToast(`Identified: ${randomArtwork.name}`, 'success');
                } else {
                    // Fallback to demo artworks
                    const demoArtworks = [
                        {
                            id: this.generateUUID(),
                            name: "The Starry Night",
                            artist: "Vincent van Gogh",
                            era: "Post-Impressionism",
                            year: "1889",
                            type: "Oil Painting",
                            description: "A famous painting depicting a swirling night sky over a quiet town, with a large cypress tree in the foreground. Van Gogh created this masterpiece while in an asylum in Saint-R√©my-de-Provence.",
                            significance: "This painting is one of the most recognized works in Western art and represents Van Gogh's unique style of expressive brushwork and vibrant color.",
                            location: "Museum of Modern Art, New York",
                            scanTime: new Date().toISOString(),
                            confidence: "high"
                        }
                    ];

                    const randomArtwork = demoArtworks[Math.floor(Math.random() * demoArtworks.length)];
                    this.state.currentArtwork = randomArtwork;
                    this.state.scannedHistory.push({
                        ...randomArtwork,
                        timestamp: new Date().toISOString(),
                        scanId: this.generateUUID()
                    });

                    this.displayArtworkInfo(randomArtwork);
                    this.logScanActivity(randomArtwork);
                    this.showToast(`Identified: ${randomArtwork.name}`, 'success');
                }

                scanButton.classList.remove('loading');
                scanButton.innerHTML = '<span>üì∑ Capture & Scan</span>';
            }

            // Identify artwork with Gemini AI
            async identifyArtworkWithGemini(imageData) {
                try {
                    const base64Data = imageData.split(',')[1];
                    
                    // FIXED: Using CONFIG.GEMINI_API_KEY
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { 
                                        text: `Analyze this image which may be a photo of an artwork, sculpture, painting, or monument. 
                                        This could be a direct photo or a photo taken through a screen/monitor.
                                        
                                        Please identify:
                                        1. ARTWORK NAME: What is the name of this artwork?
                                        2. ARTIST: Who created it?
                                        3. ERA/PERIOD: When was it created (era, century, or year)?
                                        4. TYPE: What type of artwork is it (painting, sculpture, etc.)?
                                        5. DESCRIPTION: Describe what you see
                                        6. SIGNIFICANCE: Why is this artwork important?
                                        7. LOCATION: Where is it located now?
                                        
                                        If this appears to be a famous artwork, provide detailed information.
                                        If it's not recognizable as a specific artwork, describe what you see and make an educated guess.
                                        If it's clearly not an artwork, say "NOT_ARTWORK".
                                        
                                        Format your response clearly with the above categories.` 
                                    },
                                    {
                                        inline_data: {
                                            mime_type: "image/jpeg",
                                            data: base64Data
                                        }
                                    }
                                ]
                            }],
                            generationConfig: {
                                temperature: 0.2,
                                maxOutputTokens: 1000,
                                topP: 0.8,
                                topK: 40
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Gemini API error:', response.status, errorText);
                        
                        // More specific error handling
                        if (response.status === 400) {
                            throw new Error('Invalid API request. Please check your configuration.');
                        } else if (response.status === 403) {
                            throw new Error('API key is invalid or has insufficient permissions.');
                        } else if (response.status === 429) {
                            throw new Error('API rate limit exceeded. Please try again later.');
                        } else {
                            throw new Error('AI service is temporarily unavailable. Please try again.');
                        }
                    }

                    const data = await response.json();
                    
                    if (!data.candidates || !data.candidates[0]) {
                        throw new Error('No response from AI service');
                    }

                    const responseText = data.candidates[0].content.parts[0].text;
                    console.log('Gemini Response:', responseText);
                    
                    // Check if it's not an artwork
                    if (responseText.includes('NOT_ARTWORK') || 
                        responseText.toLowerCase().includes('not an artwork') ||
                        responseText.toLowerCase().includes('cannot identify') ||
                        responseText.toLowerCase().includes('unable to recognize')) {
                        throw new Error('This does not appear to be a recognizable artwork. Please try with a clear photo of a painting, sculpture, or monument.');
                    }
                    
                    // Parse the response
                    return this.parseGeminiResponse(responseText);
                    
                } catch (error) {
                    console.error('Gemini AI Error:', error);
                    if (error.message.includes('AI service') || error.message.includes('API')) {
                        throw error;
                    }
                    throw new Error('Failed to identify artwork. Please ensure you have a clear photo and try again.');
                }
            }

            // Improved parsing for Gemini response
            parseGeminiResponse(responseText) {
                const lines = responseText.split('\n').filter(line => line.trim());
                
                // Extract information using multiple methods
                const artwork = {
                    id: this.generateUUID(),
                    name: this.extractField(lines, ['ARTWORK NAME:', 'NAME:', 'TITLE:']) || 'Unidentified Artwork',
                    artist: this.extractField(lines, ['ARTIST:', 'CREATOR:', 'BY:']) || 'Unknown Artist',
                    era: this.extractField(lines, ['ERA/PERIOD:', 'ERA:', 'PERIOD:', 'CENTURY:', 'YEAR:']) || 'Unknown Period',
                    year: this.extractField(lines, ['YEAR:', 'CREATED:', 'DATE:']) || 'Unknown',
                    type: this.extractField(lines, ['TYPE:', 'ARTWORK TYPE:', 'MEDIUM:']) || 'Artwork',
                    description: this.extractDescription(responseText),
                    significance: this.extractField(lines, ['SIGNIFICANCE:', 'IMPORTANCE:', 'WHY IMPORTANT:']) || 'Cultural and historical significance',
                    location: this.extractField(lines, ['LOCATION:', 'CURRENT LOCATION:', 'MUSEUM:']) || 'Unknown Location',
                    scanTime: new Date().toISOString(),
                    confidence: 'high'
                };

                // If we couldn't extract specific fields, use the first meaningful lines
                if (artwork.name === 'Unidentified Artwork') {
                    const meaningfulLines = lines.filter(line => 
                        !line.includes(':') && 
                        line.length > 10 && 
                        !line.toLowerCase().includes('analyze') &&
                        !line.toLowerCase().includes('identify')
                    );
                    if (meaningfulLines.length > 0) {
                        artwork.name = meaningfulLines[0].substring(0, 50);
                        artwork.confidence = 'medium';
                    }
                }

                return artwork;
            }

            extractField(lines, keywords) {
                for (const keyword of keywords) {
                    const line = lines.find(l => l.includes(keyword));
                    if (line) {
                        const value = line.split(keyword)[1]?.trim();
                        if (value && value.length > 0) {
                            return value;
                        }
                    }
                }
                return null;
            }

            extractDescription(responseText) {
                // Find the description section
                const lines = responseText.split('\n');
                const descIndex = lines.findIndex(line => 
                    line.includes('DESCRIPTION:') || 
                    line.includes('DESCRIBE:') ||
                    line.toLowerCase().includes('this is') ||
                    line.toLowerCase().includes('it shows')
                );
                
                if (descIndex !== -1) {
                    let description = '';
                    // Take the description line and next few lines
                    for (let i = descIndex; i < Math.min(descIndex + 4, lines.length); i++) {
                        const cleanLine = lines[i].replace(/^(DESCRIPTION:|DESCRIBE:)/, '').trim();
                        if (cleanLine) {
                            description += cleanLine + ' ';
                        }
                    }
                    return description.trim() || 'A visually striking artwork with cultural significance.';
                }
                
                // Fallback: use first meaningful paragraph
                const paragraphs = responseText.split('\n\n');
                for (const paragraph of paragraphs) {
                    if (paragraph.length > 50 && !paragraph.includes('ARTWORK NAME') && !paragraph.includes('ARTIST:')) {
                        return paragraph.substring(0, 200) + '...';
                    }
                }
                
                return 'An artwork identified through visual analysis.';
            }

            // Display artwork info
            displayArtworkInfo(artwork) {
                const container = document.getElementById('artworkInfo');
                
                // Apply filters for comfort mode
                let description = artwork.description;
                if (this.state.currentMode === 'comfort' && this.state.filters.age) {
                    description = this.applyAgeFilter(description, parseInt(this.state.filters.age));
                }

                container.innerHTML = `
                    <div class="artwork-header">
                        <div style="flex: 1;">
                            <h2 class="artwork-name">${artwork.name}</h2>
                            <div class="artwork-meta">
                                <span class="meta-tag">${artwork.type}</span>
                                <span class="meta-tag">${artwork.era}</span>
                                <span class="meta-tag">${artwork.artist}</span>
                                ${artwork.year !== 'Unknown' ? `<span class="meta-tag">${artwork.year}</span>` : ''}
                                ${artwork.confidence === 'medium' ? `<span class="meta-tag" style="background: #F59E0B;">Tentative</span>` : ''}
                                ${artwork.source === 'admin' ? `<span class="meta-tag" style="background: #10B981;">Verified</span>` : ''}
                            </div>
                        </div>
                    </div>
                    ${artwork.imageData ? `<img src="${artwork.imageData}" class="artwork-image-display" alt="${artwork.name}">` : ''}
                    <div class="artwork-description">${description}</div>
                    <div style="margin-bottom: 1rem; padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                        <strong>Historical Significance:</strong> ${artwork.significance}
                    </div>
                    ${artwork.location !== 'Unknown Location' ? `
                    <div style="margin-bottom: 1rem; padding: 10px; background: rgba(139, 92, 246, 0.05); border-radius: 8px;">
                        <strong>Location:</strong> ${artwork.location}
                    </div>
                    ` : ''}
                    <div class="artwork-actions">
                        <button class="action-btn read-aloud-btn" onclick="app.readAloud('${this.escapeText(artwork.name)}', '${this.escapeText(description)}')">
                            üîä Read Aloud
                        </button>
                        <button class="action-btn save-btn" onclick="app.saveArtwork('${artwork.id}')">
                            üíæ Save
                        </button>
                    </div>
                `;
                
                container.classList.remove('hidden');
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            applyAgeFilter(description, age) {
                if (age < 13) {
                    // Simplify for children
                    const sentences = description.split('. ');
                    return sentences.slice(0, 1).join('. ') + '. This is a famous artwork that many people love!';
                } else if (age < 18) {
                    // Simplify for teens
                    const sentences = description.split('. ');
                    return sentences.slice(0, 2).join('. ') + '.';
                }
                return description;
            }

            escapeText(text) {
                return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, ' ');
            }

            // Text-to-speech with better error handling
            async readAloud(title, description) {
                try {
                    const text = `${title}. ${description}`;
                    
                    if (!('speechSynthesis' in window)) {
                        this.showToast('Text-to-speech not supported in your browser', 'error');
                        return;
                    }
                    
                    // Stop any current speech
                    window.speechSynthesis.cancel();
                    
                    const speech = new SpeechSynthesisUtterance(text);
                    speech.rate = 0.8;
                    speech.pitch = 1;
                    speech.volume = 0.8;
                    
                    // Get available voices and try to use a natural one
                    const voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        // Prefer female voices for better clarity
                        const femaleVoice = voices.find(voice => 
                            voice.name.includes('Female') || voice.name.includes('female')
                        );
                        if (femaleVoice) {
                            speech.voice = femaleVoice;
                        } else {
                            speech.voice = voices[0];
                        }
                    }
                    
                    speech.onstart = () => {
                        this.showToast('Reading aloud...', 'success');
                    };
                    
                    speech.onerror = (event) => {
                        console.error('Speech synthesis error:', event);
                        this.showToast('Audio playback failed', 'error');
                    };
                    
                    window.speechSynthesis.speak(speech);
                    
                } catch (error) {
                    console.error('TTS Error:', error);
                    this.showToast('Audio playback failed', 'error');
                }
            }

            // Save artwork
            saveArtwork(artworkId) {
                const favorites = JSON.parse(localStorage.getItem('museversion_favorites') || '[]');
                if (!favorites.includes(artworkId)) {
                    favorites.push(artworkId);
                    localStorage.setItem('museversion_favorites', JSON.stringify(favorites));
                    this.showToast('Artwork saved to favorites!', 'success');
                } else {
                    this.showToast('Artwork already in favorites', 'info');
                }
            }

            // Analytics
            logScanActivity(artwork) {
                const activity = {
                    visitorId: this.state.visitorId,
                    artworkId: artwork.id,
                    artworkName: artwork.name,
                    artist: artwork.artist,
                    timestamp: new Date().toISOString(),
                    mode: this.state.currentMode
                };

                const analytics = JSON.parse(localStorage.getItem('museversion_analytics') || '[]');
                analytics.push(activity);
                localStorage.setItem('museversion_analytics', JSON.stringify(analytics));
                localStorage.setItem('museversion_history', JSON.stringify(this.state.scannedHistory));
            }

            // Museum map
            showMuseumMap() {
                this.showToast('Museum map feature coming soon!', 'info');
            }

            // Exit summary
            showExitSummary() {
                const modal = document.getElementById('summaryModal');
                const content = document.getElementById('summaryContent');
                content.innerHTML = this.generateVisitSummary();
                modal.classList.remove('hidden');
            }

            closeSummaryModal() {
                document.getElementById('summaryModal').classList.add('hidden');
            }

            // Download visit summary as text file
            downloadSummary() {
                const summaryText = this.generateDownloadableSummary();
                const blob = new Blob([summaryText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `museum-visit-summary-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showToast('Summary downloaded!', 'success');
            }

            // Generate downloadable summary text
            generateDownloadableSummary() {
                let summary = `MUSEUM VISIT SUMMARY\n`;
                summary += `Generated on: ${new Date().toLocaleString()}\n`;
                summary += `Total artworks scanned: ${this.state.scannedHistory.length}\n\n`;
                
                if (this.state.scannedHistory.length === 0) {
                    summary += `No artworks scanned during this visit.\n`;
                } else {
                    summary += `ARTWORKS EXPLORED:\n`;
                    summary += `================\n\n`;
                    
                    this.state.scannedHistory.forEach((scan, index) => {
                        summary += `${index + 1}. ${scan.name}\n`;
                        summary += `   Artist: ${scan.artist}\n`;
                        summary += `   Type: ${scan.type}\n`;
                        summary += `   Era: ${scan.era}\n`;
                        summary += `   Scanned: ${new Date(scan.timestamp).toLocaleString()}\n\n`;
                    });
                    
                    const uniqueArtists = [...new Set(this.state.scannedHistory.map(scan => scan.artist))];
                    summary += `STATISTICS:\n`;
                    summary += `===========\n`;
                    summary += `Total artworks: ${this.state.scannedHistory.length}\n`;
                    summary += `Unique artists: ${uniqueArtists.length}\n`;
                    summary += `Visit duration: From ${new Date(this.state.scannedHistory[0].timestamp).toLocaleTimeString()} to ${new Date().toLocaleTimeString()}\n`;
                }
                
                return summary;
            }

            // Completely exit the app
            exitApp() {
                // Stop camera stream
                if (this.state.cameraStream) {
                    this.state.cameraStream.getTracks().forEach(track => track.stop());
                }
                
                // Show exit confirmation
                this.showToast('Thank you for visiting!', 'success');
                
                // Close all modals
                this.closeSummaryModal();
                
                // Reset app state
                setTimeout(() => {
                    this.state.scannedHistory = [];
                    this.state.currentArtwork = null;
                    document.getElementById('artworkInfo').classList.add('hidden');
                    this.showToast('App reset. Ready for new visit!', 'info');
                }, 2000);
            }

            generateVisitSummary() {
                if (this.state.scannedHistory.length === 0) {
                    return `
                        <p style="text-align: center; padding: 2rem;">No artworks scanned during this visit.</p>
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                            <button class="action-btn read-aloud-btn" onclick="app.downloadSummary()" style="margin: 0;">
                                üì• Download Empty Summary
                            </button>
                            <button class="action-btn save-btn" onclick="app.exitApp()" style="margin: 0; background: #EF4444; color: white;">
                                üö™ Exit App
                            </button>
                        </div>
                    `;
                }

                let html = `
                    <h3 style="margin-bottom: 1rem;">Your Museum Journey</h3>
                    <p>You explored ${this.state.scannedHistory.length} artworks:</p>
                    <div style="max-height: 300px; overflow-y: auto; margin: 1rem 0;">
                `;
                
                this.state.scannedHistory.forEach((scan, index) => {
                    html += `
                        <div style="padding: 0.75rem; background: var(--secondary-bg); border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="font-weight: 600;">${scan.name}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">by ${scan.artist}</div>
                            <div style="font-size: 0.8rem; color: var(--lighter-gray); margin-top: 0.25rem;">
                                ${new Date(scan.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                // Add statistics
                const uniqueArtists = [...new Set(this.state.scannedHistory.map(scan => scan.artist))];
                html += `
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--secondary-bg); border-radius: 8px;">
                        <h4 style="margin-bottom: 0.5rem;">Visit Statistics</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>Artworks Scanned: <strong>${this.state.scannedHistory.length}</strong></div>
                            <div>Unique Artists: <strong>${uniqueArtists.length}</strong></div>
                        </div>
                    </div>
                `;
                
                // Add download and exit buttons
                html += `
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="action-btn read-aloud-btn" onclick="app.downloadSummary()" style="flex: 1; margin: 0;">
                            üì• Download Summary
                        </button>
                        <button class="action-btn save-btn" onclick="app.exitApp()" style="flex: 1; margin: 0; background: #EF4444; color: white;">
                            üö™ Exit App
                        </button>
                    </div>
                `;
                
                return html;
            }

            // Utility functions
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast';
                
                if (type === 'success') toast.style.background = '#10B981';
                else if (type === 'error') toast.style.background = '#EF4444';
                else if (type === 'warning') toast.style.background = '#F59E0B';
                else toast.style.background = '#6B7280';
                
                toast.classList.remove('hidden');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 4000);
            }
        }

        // Initialize app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new MuseVersionApp();
            app.init();
        });

        // Clean up camera
        window.addEventListener('beforeunload', () => {
            if (app && app.state.cameraStream) {
                app.state.cameraStream.getTracks().forEach(track => track.stop());
            }
        });

        // Handle page visibility changes for mobile optimization
        document.addEventListener('visibilitychange', () => {
            if (app && document.hidden && app.state.cameraStream) {
                // Stop camera when page is not visible to save resources
                app.state.cameraStream.getTracks().forEach(track => track.stop());
                app.state.cameraStream = null;
            }
        });
    </script>
</body>
</html>
